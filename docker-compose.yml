version: '3.8'

services:
  # ------------------------------------------------------------
  # 1. Infrastructure (Databases ve Kafka)
  # ------------------------------------------------------------

  user-db:
    image: postgres:15
    container_name: user-db
    environment:
      POSTGRES_USER: alper
      POSTGRES_PASSWORD: alper
      POSTGRES_DB: userdb
    ports:
      - "5433:5432"
    networks:
      - freelance-net

  gig-db:
    image: postgres:15
    container_name: gig-db
    environment:
      POSTGRES_USER: alper
      POSTGRES_PASSWORD: alper
      POSTGRES_DB: gigdb
    ports:
      - "5434:5432"
    networks:
      - freelance-net

  chat-db:
    image: postgres:15
    container_name: chat-db
    environment:
      POSTGRES_USER: alper
      POSTGRES_PASSWORD: alper
      POSTGRES_DB: chatdb
    ports:
      - "5435:5432"
    networks:
      - freelance-net

  payment-db:
    image: postgres:15
    container_name: payment-db
    environment:
      POSTGRES_USER: alper
      POSTGRES_PASSWORD: alper
      POSTGRES_DB: paymentdb
    ports:
      - "5436:5432"
    networks:
      - freelance-net

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    command:
      - redpanda
      - start
      - --mode dev-container
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"
      - "9644:9644"
    networks:
      - freelance-net

  # ------------------------------------------------------------
  # 2. Microservices (Backend & Frontend)
  # ------------------------------------------------------------

  user-service:
    build:
      context: ./user-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: user-service
    ports:
      - "8080:8080"
    environment:
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://user-db:5432/userdb
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=update
    depends_on:
      - user-db
    networks:
      - freelance-net

  gig-service:
    build:
      context: ./gig-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: gig-service
    ports:
      - "8081:8080"
    environment:
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://gig-db:5432/gigdb
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=update
    depends_on:
      - gig-db
    networks:
      - freelance-net

  chat-service:
    build:
      context: ./chat-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: chat-service
    ports:
      - "8082:8080"
    environment:
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://chat-db:5432/chatdb
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=update
    depends_on:
      - chat-db
    networks:
      - freelance-net

  payment-service:
    build:
      context: ./payment-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: payment-service
    ports:
      - "8083:8080"
    environment:
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://payment-db:5432/paymentdb
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=update
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
    depends_on:
      - payment-db
      - redpanda
    networks:
      - freelance-net

  notification-service:
    build:
      context: ./notification-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: notification-service
    ports:
      - "8084:8080"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
    depends_on:
      - redpanda
    networks:
      - freelance-net

  frontend-service:
    build:
      context: ./frontend-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: frontend-service
    ports:
      - "8090:8090"
    environment:
      - QUARKUS_REST_CLIENT_USER_API_URL=http://user-service:8080
      - QUARKUS_REST_CLIENT_GIG_API_URL=http://gig-service:8080
      - QUARKUS_REST_CLIENT_CHAT_API_URL=http://chat-service:8080
      - QUARKUS_REST_CLIENT_PAYMENT_API_URL=http://payment-service:8080
    depends_on:
      - user-service
      - gig-service
    networks:
      - freelance-net

networks:
  freelance-net:
    driver: bridge